<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - 3D Product Viewer</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #fff; overflow: hidden; }
        #container { position: relative; width: 100vw; height: 100vh; }
        #canvas { width: 100%; height: 100%; display: block; }
        
        #controls {
            position: absolute; top: 15px; left: 15px;
            background: rgba(255,255,255,0.95); padding: 12px;
            border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid rgba(0,0,0,0.1); width: 180px;
        }
        
        .btn {
            padding: 8px 10px; margin: 3px 0; width: 100%;
            background: #4a6fa5; color: white; border: none;
            border-radius: 6px; cursor: pointer; font-size: 12px;
        }
        
        .btn:hover { background: #3a5a8a; }
        .btn-success { background: #10b981; }
        .btn-success:hover { background: #0da271; }
        
        #adminPanel {
            display: none; margin-top: 10px; padding: 10px;
            background: rgba(248,249,250,0.9); border-radius: 6px;
            border: 1px solid rgba(0,0,0,0.1);
        }
        
        .admin-input {
            width: 100%; padding: 6px 8px; margin: 3px 0;
            border: 1px solid #dee2e6; border-radius: 4px;
            font-size: 12px;
        }
        
        #dimensionsDisplay {
            position: absolute; top: 15px; right: 15px;
            background: rgba(255,255,255,0.95); padding: 12px;
            border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid rgba(0,0,0,0.1); min-width: 150px;
            display: none;
        }
        
        #loading {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: #fff;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 1000;
        }
        
        .spinner {
            width: 50px; height: 50px;
            border: 3px solid rgba(74,111,165,0.3);
            border-radius: 50%; border-top-color: #4a6fa5;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        <div>Loading Admin Viewer</div>
    </div>

    <div id="container">
        <canvas id="canvas"></canvas>
        
        <div id="controls">
            <div><button id="switchModel" class="btn">Switch View</button></div>
            <div><button id="resetView" class="btn">Reset View</button></div>
            <div><button id="toggleDimensions" class="btn">Show Dimensions</button></div>
            <div><button id="toggleAdmin" class="btn">Admin Panel</button></div>
            
            <div id="adminPanel">
                <input type="file" id="uploadMain" accept=".glb" class="admin-input">
                <input type="file" id="uploadCrossSection" accept=".glb" class="admin-input">
                <button id="generateLink" class="btn btn-success">Generate Customer Link</button>
            </div>
        </div>
        
        <div id="dimensionsDisplay">
            <div style="font-weight: bold; margin-bottom: 8px;">DIMENSIONS</div>
            <div>X (Width): <span id="dimX">0.00 mm</span></div>
            <div>Y (Depth): <span id="dimY">0.00 mm</span></div>
            <div>Z (Height): <span id="dimZ">0.00 mm</span></div>
            <div id="thicknessItem" style="display:none;">Thickness: <span id="dimThickness">0.00 mm</span></div>
        </div>
    </div>

    <script>
        let scene, camera, renderer, controls;
        let mainModel, crossModel, currentModel;
        let dimensionsVisible = false;

        function init() {
            console.log("Initializing...");
            
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xffffff);
            
            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.set(5, 5, 5);
            
            renderer = new THREE.WebGLRenderer({ 
                canvas: document.getElementById('canvas'),
                antialias: true 
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            
            // Lights
            scene.add(new THREE.AmbientLight(0xffffff, 0.6));
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(10, 20, 10);
            scene.add(dirLight);
            
            // Load models
            loadModels();
            
            // Setup events
            setupEvents();
            
            // Start animation
            animate();
            
            // Hide loading
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
            }, 500);
        }
        
        function loadModels() {
            const loader = new THREE.GLTFLoader();
            
            loader.load('main.glb', function(gltf) {
                mainModel = gltf.scene;
                mainModel.name = 'main';
                scene.add(mainModel);
                
                loader.load('cross-section.glb', function(gltf) {
                    crossModel = gltf.scene;
                    crossModel.name = 'cross-section';
                    crossModel.visible = false;
                    scene.add(crossModel);
                    
                    currentModel = mainModel;
                    centerModel(currentModel);
                }, undefined, function() {
                    createCrossSectionPlaceholder();
                    currentModel = mainModel;
                    centerModel(currentModel);
                });
            }, undefined, function() {
                createMainPlaceholder();
                createCrossSectionPlaceholder();
                currentModel = mainModel;
                centerModel(currentModel);
            });
        }
        
        function createMainPlaceholder() {
            const geometry = new THREE.BoxGeometry(2, 2, 2);
            const material = new THREE.MeshStandardMaterial({ color: 0x4a6fa5 });
            mainModel = new THREE.Mesh(geometry, material);
            mainModel.name = 'main';
            scene.add(mainModel);
        }
        
        function createCrossSectionPlaceholder() {
            const geometry = new THREE.BoxGeometry(1.8, 0.3, 1.8);
            const material = new THREE.MeshStandardMaterial({ 
                color: 0xf59e0b,
                transparent: true,
                opacity: 0.8
            });
            crossModel = new THREE.Mesh(geometry, material);
            crossModel.name = 'cross-section';
            crossModel.visible = false;
            scene.add(crossModel);
        }
        
        function switchModel() {
            if (!mainModel || !crossModel) return;
            
            if (currentModel === mainModel) {
                mainModel.visible = false;
                crossModel.visible = true;
                currentModel = crossModel;
                document.getElementById('switchModel').textContent = 'Switch to Main';
                document.getElementById('thicknessItem').style.display = 'block';
            } else {
                crossModel.visible = false;
                mainModel.visible = true;
                currentModel = mainModel;
                document.getElementById('switchModel').textContent = 'Switch to Cross-Section';
                document.getElementById('thicknessItem').style.display = 'none';
            }
            
            centerModel(currentModel);
        }
        
        function centerModel(model) {
            const box = new THREE.Box3().setFromObject(model);
            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());
            
            controls.target.copy(center);
            controls.update();
            
            const maxDim = Math.max(size.x, size.y, size.z);
            camera.position.copy(center);
            camera.position.z += maxDim * 2;
            camera.lookAt(center);
        }
        
        function toggleDimensions() {
            if (dimensionsVisible) {
                hideDimensions();
            } else {
                showDimensions();
            }
        }
        
        function showDimensions() {
            if (!currentModel) return;
            
            const box = new THREE.Box3().setFromObject(currentModel);
            const size = box.getSize(new THREE.Vector3());
            const scale = 1000;
            
            document.getElementById('dimX').textContent = (size.x * scale).toFixed(2) + ' mm';
            document.getElementById('dimY').textContent = (size.z * scale).toFixed(2) + ' mm'; // Y = Depth
            document.getElementById('dimZ').textContent = (size.y * scale).toFixed(2) + ' mm'; // Z = Height
            
            if (currentModel.name === 'cross-section') {
                const thickness = Math.min(size.x, size.y, size.z) * scale;
                document.getElementById('dimThickness').textContent = thickness.toFixed(2) + ' mm';
            }
            
            document.getElementById('dimensionsDisplay').style.display = 'block';
            dimensionsVisible = true;
            document.getElementById('toggleDimensions').textContent = 'Hide Dimensions';
            
            setTimeout(hideDimensions, 300000);
        }
        
        function hideDimensions() {
            document.getElementById('dimensionsDisplay').style.display = 'none';
            dimensionsVisible = false;
            document.getElementById('toggleDimensions').textContent = 'Show Dimensions';
        }
        
        function toggleAdminPanel() {
            const panel = document.getElementById('adminPanel');
            if (panel.style.display === 'block') {
                panel.style.display = 'none';
                document.getElementById('toggleAdmin').textContent = 'Admin Panel';
            } else {
                panel.style.display = 'block';
                document.getElementById('toggleAdmin').textContent = 'Close Admin';
            }
        }
        
        function generateCustomerLink() {
            // Save current state to localStorage
            const state = {
                timestamp: new Date().getTime(),
                currentView: currentModel.name
            };
            
            localStorage.setItem('customerViewState', JSON.stringify(state));
            
            // Create a customer link that opens customer-viewer.html
            const link = window.location.href.replace('admin-viewer.html', 'customer-viewer.html');
            
            // Show link to copy
            const linkText = prompt("Copy this link to share with customers:", link);
            
            if (linkText) {
                navigator.clipboard.writeText(linkText).then(() => {
                    alert("Link copied to clipboard!");
                }).catch(() => {
                    // Fallback for older browsers
                    const textArea = document.createElement("textarea");
                    textArea.value = linkText;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand("copy");
                    document.body.removeChild(textArea);
                    alert("Link copied to clipboard!");
                });
            }
        }
        
        function setupEvents() {
            // Canvas events
            renderer.domElement.addEventListener('mousedown', (e) => {
                if (e.button === 0) {
                    if (!dimensionsVisible) showDimensions();
                } else if (e.button === 2) {
                    hideDimensions();
                }
            });
            
            renderer.domElement.addEventListener('contextmenu', (e) => e.preventDefault());
            
            // Button events
            document.getElementById('switchModel').addEventListener('click', switchModel);
            document.getElementById('resetView').addEventListener('click', () => centerModel(currentModel));
            document.getElementById('toggleDimensions').addEventListener('click', toggleDimensions);
            document.getElementById('toggleAdmin').addEventListener('click', toggleAdminPanel);
            document.getElementById('generateLink').addEventListener('click', generateCustomerLink);
            
            // Window resize
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }
        
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>