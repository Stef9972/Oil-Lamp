<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Product Viewer</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #fff; overflow: hidden; }
        #container { position: relative; width: 100vw; height: 100vh; }
        #canvas { width: 100%; height: 100%; display: block; }
        
        .btn {
            position: absolute; top: 15px; left: 15px;
            padding: 8px 12px; background: #4a6fa5;
            color: white; border: none; border-radius: 6px;
            cursor: pointer; font-size: 12px;
        }
        
        #resetBtn {
            top: 50px;
            background: #6c757d;
        }
        
        #dimensions {
            position: absolute; top: 15px; right: 15px;
            background: rgba(255,255,255,0.95); padding: 12px;
            border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid rgba(0,0,0,0.1); display: none;
            font-size: 12px; min-width: 150px;
        }
        
        #loading {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: #fff;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 1000;
        }
        
        .spinner {
            width: 50px; height: 50px;
            border: 3px solid rgba(74,111,165,0.3);
            border-radius: 50%; border-top-color: #4a6fa5;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        <div>Loading 3D Viewer</div>
    </div>

    <div id="container">
        <canvas id="canvas"></canvas>
        <button id="switchBtn" class="btn">Switch View</button>
        <button id="resetBtn" class="btn">Reset View</button>
        <div id="dimensions">
            <div style="font-weight: bold; margin-bottom: 8px;">DIMENSIONS</div>
            <div>X (Width): <span id="dimX">0.00 mm</span></div>
            <div>Y (Depth): <span id="dimY">0.00 mm</span></div>
            <div>Z (Height): <span id="dimZ">0.00 mm</span></div>
            <div id="thicknessItem" style="display:none;">Thickness: <span id="dimThickness">0.00 mm</span></div>
        </div>
    </div>

    <script>
        let scene, camera, renderer, controls;
        let mainModel, crossModel, currentModel;
        let dimensionsVisible = false;
        let dimTimer;

        function init() {
            console.log("Initializing customer viewer...");
            
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xffffff);
            
            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.set(5, 5, 5);
            
            renderer = new THREE.WebGLRenderer({ 
                canvas: document.getElementById('canvas'),
                antialias: true 
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            
            // Lights
            scene.add(new THREE.AmbientLight(0xffffff, 0.6));
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(10, 20, 10);
            scene.add(dirLight);
            
            // Load models
            loadModels();
            
            // Setup events
            setupEvents();
            
            // Start animation
            animate();
            
            // Hide loading
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
            }, 500);
        }
        
        function loadModels() {
            const loader = new THREE.GLTFLoader();
            
            loader.load('main.glb', function(gltf) {
                mainModel = gltf.scene;
                mainModel.name = 'main';
                scene.add(mainModel);
                
                loader.load('cross-section.glb', function(gltf) {
                    crossModel = gltf.scene;
                    crossModel.name = 'cross-section';
                    crossModel.visible = false;
                    scene.add(crossModel);
                    
                    // Check saved state
                    try {
                        const savedState = JSON.parse(localStorage.getItem('customerViewState'));
                        if (savedState && savedState.currentView === 'cross-section') {
                            mainModel.visible = false;
                            crossModel.visible = true;
                            currentModel = crossModel;
                            document.getElementById('switchBtn').textContent = 'Switch to Main';
                            document.getElementById('thicknessItem').style.display = 'block';
                        } else {
                            currentModel = mainModel;
                        }
                    } catch {
                        currentModel = mainModel;
                    }
                    
                    centerModel(currentModel);
                }, undefined, function() {
                    console.log("Cross-section not found");
                    currentModel = mainModel;
                    centerModel(currentModel);
                });
            }, undefined, function() {
                console.log("Main model not found");
                // Create placeholders if needed
            });
        }
        
        function switchModel() {
            if (!mainModel || !crossModel) return;
            
            if (currentModel === mainModel) {
                mainModel.visible = false;
                crossModel.visible = true;
                currentModel = crossModel;
                document.getElementById('switchBtn').textContent = 'Switch to Main';
                document.getElementById('thicknessItem').style.display = 'block';
            } else {
                crossModel.visible = false;
                mainModel.visible = true;
                currentModel = mainModel;
                document.getElementById('switchBtn').textContent = 'Switch to Cross-Section';
                document.getElementById('thicknessItem').style.display = 'none';
            }
            
            centerModel(currentModel);
        }
        
        function centerModel(model) {
            const box = new THREE.Box3().setFromObject(model);
            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());
            
            controls.target.copy(center);
            controls.update();
            
            const maxDim = Math.max(size.x, size.y, size.z);
            camera.position.copy(center);
            camera.position.z += maxDim * 2;
            camera.lookAt(center);
        }
        
        function showDimensions() {
            if (!currentModel || dimensionsVisible) return;
            
            const box = new THREE.Box3().setFromObject(currentModel);
            const size = box.getSize(new THREE.Vector3());
            const scale = 1000;
            
            document.getElementById('dimX').textContent = (size.x * scale).toFixed(2) + ' mm';
            document.getElementById('dimY').textContent = (size.z * scale).toFixed(2) + ' mm';
            document.getElementById('dimZ').textContent = (size.y * scale).toFixed(2) + ' mm';
            
            if (currentModel.name === 'cross-section') {
                const thickness = Math.min(size.x, size.y, size.z) * scale;
                document.getElementById('dimThickness').textContent = thickness.toFixed(2) + ' mm';
            }
            
            document.getElementById('dimensions').style.display = 'block';
            dimensionsVisible = true;
            
            if (dimTimer) clearTimeout(dimTimer);
            dimTimer = setTimeout(() => {
                document.getElementById('dimensions').style.display = 'none';
                dimensionsVisible = false;
            }, 300000);
        }
        
        function hideDimensions() {
            if (!dimensionsVisible) return;
            document.getElementById('dimensions').style.display = 'none';
            dimensionsVisible = false;
            if (dimTimer) clearTimeout(dimTimer);
        }
        
        function setupEvents() {
            // Canvas events
            renderer.domElement.addEventListener('mousedown', (e) => {
                if (e.button === 0) {
                    if (!dimensionsVisible) showDimensions();
                } else if (e.button === 2) {
                    hideDimensions();
                }
            });
            
            renderer.domElement.addEventListener('contextmenu', (e) => e.preventDefault());
            
            // Button events
            document.getElementById('switchBtn').addEventListener('click', switchModel);
            document.getElementById('resetBtn').addEventListener('click', () => centerModel(currentModel));
            
            // Window resize
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }
        
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>